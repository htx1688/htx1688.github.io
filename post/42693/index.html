<!DOCTYPE html>
<html
  lang="zh-cn"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
          一文详解十大智能合约安全威胁之合约升级漏洞 - 区块大全
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="佚名" /><meta name="description" content="到底哪些安全威胁从发生频率和危害性上能称为Top10的呢？SharkTeam合约安全系列课程之【十大智能合约安全威胁】。" />
<meta name="keywords" content="智能合约" />







<meta name="generator" content="Hugo 0.120.4" />


<link rel="canonical" href="/post/42693/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.d8d87b982993a745e5e7b6a6cbf257be8c3e82aab5e485f0908ad7e6c3501ab2.css" integrity="sha256-2Nh7mCmTp0Xl57amy/JXvow&#43;gqq15IXwkIrX5sNQGrI=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="一文详解十大智能合约安全威胁之合约升级漏洞" />
<meta property="og:description" content="到底哪些安全威胁从发生频率和危害性上能称为Top10的呢？SharkTeam合约安全系列课程之【十大智能合约安全威胁】。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/42693/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-09-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-09-16T00:00:00+00:00" />

<meta itemprop="name" content="一文详解十大智能合约安全威胁之合约升级漏洞">
<meta itemprop="description" content="到底哪些安全威胁从发生频率和危害性上能称为Top10的呢？SharkTeam合约安全系列课程之【十大智能合约安全威胁】。"><meta itemprop="datePublished" content="2022-09-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-09-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="6625">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="一文详解十大智能合约安全威胁之合约升级漏洞"/>
<meta name="twitter:description" content="到底哪些安全威胁从发生频率和危害性上能称为Top10的呢？SharkTeam合约安全系列课程之【十大智能合约安全威胁】。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">区块大全</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">分类</a>
          
        
      </li>
    

    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    

    


    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      区块大全
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">分类</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title">一文详解十大智能合约安全威胁之合约升级漏洞</h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      佚名
    
  </div>

  <div class="post-meta-time">
    <time datetime="2022-09-16">
      2022-09-16
    </time>
  </div>

  


  <div class="post-meta__right">
    <span class="post-meta-more">
        约 6625 字 -
        预计阅读 14 分钟
      </span>

    <div class="post-meta-category">
        <a href="/categories/%E5%85%B6%E5%AE%83%E6%96%87%E7%AB%A0/"> 其它文章 </a>
          
      </div>


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <table>
    <thead>
        <tr>
            <th style="text-align:left">推荐平台</th>
            <th style="text-align:left">链接</th>
            <th style="text-align:left">平台介绍</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">币安网</span></td>
            <td style="text-align:left"><span style="white-space:nowrap"><a
                        href="https://www.okbtc.cn/binance?ref=githubio">注册链接</a></span></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/binance?ref=githubio">币安是全球领先的区块链生态系统，推出了一系列产品，其中包括最大的加密货币交易平台。我们的使命是在未来成为全球性加密货币基础架构供应商。</a>
            </td>
        </tr>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">欧易OKX</span></td>
            <td style="text-align:left"><a href="https://www.okbtc.cn/okx?ref=githubio">注册链接</a></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/okx?ref=githubio">欧易是全球著名的数字资产交易平台之一，主要面向全球用户提供比特币、莱特币、以太币等数字资产的币币和衍生品交易服务。</a>
            </td>
        </tr>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">HTX火币</span></td>
            <td style="text-align:left"><a href="https://www.okbtc.cn/htx?ref=githubio">注册链接</a></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/htx?ref=githubio">火币全球专业站，是火币集团旗下服务于全球专业交易用户的创新数字资产国际站，致力于发现优质的创新数字资产投资机会。</a>
            </td>
        </tr>
    </tbody>
</table>
<p><strong>问：我们常提到的智能合约漏洞真的是实际中威胁最大、发生最频繁的安全漏洞吗？</strong></p>
<p>答：完全不是那样。例如“溢出”、“外部调用”等常提到的智能合约安全漏洞并不是最常发生，威胁最大的。</p>
<p>到底哪些安全威胁从发生频率和危害性上能称为Top10的呢？SharkTeam合约安全系列课程之【十大智能合约安全威胁】，第五课【详解合约升级漏洞】。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_ofizjt83w7.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<h2 id="一什么是合约升级"><strong>一、什么是合约升级？</strong></h2>
<p>智能合约部署后默认是不可变的，一旦你创建了它们，就没有办法改变它们。每个智能合约都有一个唯一的地址，用户将交易发送到智能合约的地址，来执行存储在该合约中的代码。但是，在实际应用中，开发者通常因为业务升级或安全升级的需求需要通过技术的手段来更新合约逻辑，因此合约升级的开发模式应运而生。常见的几种合约升级模式如下。</p>
<h3 id="11继承存储模式"><strong>1.1继承存储模式</strong></h3>
<p>继承存储模式通过为代理合约和逻辑合约所需的状态变量提供严格的存储顺序来解决状态碰撞问题，代理合约委托逻辑合约进行调用。因此，只有代理合约的存储在使用。继承了公共存储合约的代理合约可以访问其父合约的所有状态变量，每个状态变量根据其索引占据适当的内存位置。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_b3ssz4srzp.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>初始化流程如下：</p>
<p>（1）部署Registry合约</p>
<p>（2）部署合约的初始版本 （v1），确保它继承了“可升级”合约</p>
<p>（3）将初始版本的地址注册到Registry</p>
<p>（4）请求Registry合约创建UpgradeabilityProxy实例</p>
<p>（5）调用UpgradeabilityProxy来升级到合约的初始版本</p>
<p>升级流程如下：</p>
<p>（1）部署从初始版本继承的新版本的合约 （v2），以确保它保留代理的存储结构和合约初始版本中的存储结构</p>
<p>（2）将合约的新版本注册到Registry</p>
<p>（3）调用UpgradeabilityProxy实例以升级到新的注册版本</p>
<p>虽然继承存储模式解决了可升级合约的存储碰撞问题，但这种方法也有自己的缺点。由于所有先前声明的状态变量都需要被复制到新部署的版本中，因此升级变得昂贵。其中一些可能没有被使用，最终会不必要地占用内存。由于公共存储模式，逻辑合约变得与代理合约紧密耦合。因此，不可能将这些逻辑合约用于不继承公共存储合约的任何其他代理。</p>
<h3 id="12非结构化存储模式"><strong>1.2非结构化存储模式</strong></h3>
<p>在这种模式中，代理合约往往是具有一些基本函数的最小化合约，大部分的业务逻辑都在逻辑合约里面完成，新的逻辑合约保持了最新的实现合约中存在的状态变量的顺序。代理合约一般需要所有者和实现变量来维持所有权和版本控制，代理合约将这些属性指定为常量，它们被设置在合约的字节码内。OpenZepplin在其可升级的合约服务中使用了非结构化的存储模式。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_ecn2i0antq.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>初始化流程如下：</p>
<p>（1）部署OwnedUpgradeabilityProxy实例</p>
<p>（2）部署合约的初始版本 （v1）</p>
<p>（3）调用OwnedUpgradeabilityProxy实例来升级到初始版本的地址</p>
<p>（4）如果逻辑合约依赖它的构造函数来设置一些初始状态，那么在它与代理链接后，就必须重新进行设置，因为代理的存储不知道这些值。OwnedUpgradeabilityProxy有一个函数upgradeToAndCall，专门用来调用逻辑合约上的一些函数，在代理升级到它之后重新进行设置</p>
<p>升级流程如下：</p>
<p>（1）部署新版本的合约 （v2），确保它继承以前版本中使用的状态变量结构</p>
<p>（2）调用OwnedUpgradeabilityProxy实例来升级到新合约版本的地址</p>
<h3 id="13永久存储模式"><strong>1.3永久存储模式</strong></h3>
<p>这种模式的目标是尽量减少存储复制的要求。在这种模式中，一个单独的合约被维护为永久存储合约。因此，所有的逻辑版本都利用这个永久存储合约来满足其存储需求。因此，存储复制的要求被从升级模式中移除，这种方法大大降低了升级成本。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_7vkht5tp98.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>初始化流程如下：</p>
<p>（1）部署一个EternalStorageProxy实例</p>
<p>（2）部署一个初始版本的合约（v1）</p>
<p>（3）调用EternalStorageProxy实例来升级到初始版本的地址</p>
<p>（4）如果逻辑合约依赖其构造函数来设置一些初始状态，那就必须在其链接到代理后重新进行，因为代理的存储不知道这些值。EternalStorageProxy有一个函数upgradeToAndCall，专门用来调用逻辑合约上的一些函数，在代理升级到它之后重新进行设置</p>
<p>升级流程如下：</p>
<p>（1）部署一个新版本的合约（v2），确保它拥有永久存储结构</p>
<p>（2）调用EternalStorageProxy实例来升级到新版本</p>
<h3 id="14--diamond-模式"><strong>1.4</strong>  <strong>Diamond 模式</strong></h3>
<p>Solidity 合约的最大限制为 24KB。因此，每个合约的大小永远不能超过 24KB。Diamond 模式使开发人员能够编写没有大小限制的智能合约。此模式还支持升级，而无需重新部署现有功能，详细Diamond 标准可见EIP 2535。</p>
<p>Diamond 是一个合约，它将调用委托给称为面的实现合约。Diamond 合约实现了一个 diamondCut 函数，它提供了添加/替换/删除的能力。除了 diamondCut 函数之外，还实现了一组 loupe 函数。这些函数显示了关于所实现的Diamond 的信息。Diamond 合约维护了一个selectorToFacet的映射，这基本上是一个函数签名到实现合约地址的映射。当用户调用一个函数时，Diamond 代理的回退函数使用函数签名来寻找这个映射中的实现地址。在找到函数签名的地址后，回退函数只是将调用委托给实现合约，并将响应返回给用户。</p>
<p>Diamond 代理依靠的是一种存储模式。该代理被一些被称为面的实现合约所共享。理想情况下，每个切面都有自己的存储。然而，根据实施要求，面可以与其他面共享存储。DiamondStorage和AppStorage是一些流行的存储模式，分别用于隔离和共享存储。</p>
<p>Diamond 模式为创建模块化的智能合约应用程序提供了一种简洁的方式，没有任何最大尺寸限制。因此，它似乎是那些希望在未来扩大规模的大型智能合约应用程序的完美选择。</p>
<h3 id="15-create2"><strong>1.5 create2</strong></h3>
<p>create操作码用于在以太坊区块链上部署合约。合约地址是通过散列部署者的地址和该地址的nonce来生成的。Nonce是一个标量值，等于从部署者的地址发送的交易数量。同样，在合约账户的情况下，nonce是该账户创建合约的数量。nonce有助于保持交易的顺序（来自一个地址的低nonce交易会先被开采），并防止重入攻击。nonce是一个递增的数字，防止create操作码产生重复的地址。只要在当前和下一个nonce之间没有新的交易发生，就有可能通过简单散列下一个nonce和地址来知道下一个合约的地址。</p>
<p>create2操作码被添加到以太坊虚拟机中，作为君士坦丁堡硬分叉的一部分，这个操作码也被用来部署智能合约。create2使用一些用户控制的输入来推导出智能合约的地址。换句话说，这个操作码提供了一种方法，在将智能合约部署到区块链之前计算其地址。这个操作码不是对部署者的地址和nonce进行散列，而是对部署者的地址、salt（由部署者提供的32字节的字符串）和合约的字节码的哈希进行散列。由于这个操作码的所有参数都由用户控制，create2提供了一种预先确定合约地址的方法。这个方法在推导出优化gas的合约地址和实现像状态通道这样的扩展解决方案时非常有用。在可升级性方面，create2提供了创建可变合约（metamorphic contract）的能力，这些合约可以用新的字节码重新部署到同一地址。</p>
<p>EVM包含一个selfdestruct 操作码，智能合约可以通过这个操作码来删除。为了在原始地址上部署一个新的字节码，该地址必须是自由的，因为智能合约是不可改变的。有几种方法可以将新的字节码部署到原始地址上，一个低效的方法是找到salt的参数，与新的字节码相结合，生成原始地址，寻找正确的salt参数的计算可以在链下完成。然而，这并不是一个很好的方法。另一个选择是部署一个可变合约。如上所述，可变合约可以使用不同的字节码重新部署到原始地址。</p>
<p>建立一个良好的升级模式，需要一个可变合约工厂。这个可变合约工厂的目的是通过改变其实现而不改变其地址来促进升级。在部署合约时，对应的部署函数使用create2预先计算可变合约的地址，实现合约是使用传统的create操作码部署的。这个操作码使用地址和nonce来生成地址，并将合约部署到该地址。要求实现地址不能为零。否则，实现合约没有被正确部署，函数必须返回。部署完实现合约后，工厂状态被更新来存储当前的实现合约。</p>
<p>值得注意的是，实现合约必须是自毁的，这也会使可变合约自毁。在重新部署可变合约之前，要确保可变合约使用selfdestruct操作码进行自我销毁。由于create2操作码的存在，可变合约的地址总是提前知道的。此外，由于它能够改变其实现，可变合约每次都可以用不同的实现重新部署。</p>
<p>使用create2是有优势的，但它也有自己的风险。最重要的风险是，每次合约被重新部署时，其存储都会被抹去。另外，带有selfdestruct操作码的实现合约可能不是一个可靠的资金存储方式。因此，在采用这种智能合约升级模式之前，开发者必须谨慎行事。</p>
<h2 id="二攻击事件分析"><strong>二、攻击事件分析</strong></h2>
<h3 id="21-uranium-finance"><strong>2.1 Uranium Finance</strong></h3>
<p>2021年4月28日，币安智能链上区块链项目 Uranium Finance在流动性迁移过程中被攻击，涉及资金为 5000 万美元。攻击合约地址：0x2b528a28451e9853F51616f3B0f6D82Af8bEA6Ae。</p>
<p>我们从攻击合约中找到的项目合约地址并进行了攻击原理分析，攻击流程如下：</p>
<p>（1）首先查看攻击合约的代码发现，这个合约的源码没有公开，通过反编译查看其源码</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_aecpieop8l.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（2）通过浏览器查看最早的攻击交易</p>
<p>0x5a504fe72ef7fc76dfeb4d979e533af4e23fe37e90b5516186d5787893c37991,可得到攻击者调用的合约方法对应的签名为52f18fc3</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_mnkcmknoh3.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（3）从反编译代码中寻找这个编码后的合约方法，可以找到这个合约攻击的项目方合约地址，也就是 Uranium 项目所在的地址：0xa943ea143cd7e79806d670f4a7cf08f8922a454f</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_dlekogh160.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（4）通过分析，Uranium 项目合约中的漏洞出现在 UraniumPair.sol 合约中的 swap 函数中，这个漏洞会导致任何人可以随意的转出合约中的数字资产，而只需要付出一点点的代价。可以看到 swap 中，最后是一个10的8次方数和一个10的6次方数的比较，这是一个几乎是恒等的判断，这就意味着只要按照一定的套路不断的执行 swap 函数，就可以清空这个合约中所有的数字资产。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_hvla6g4lzm.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>我们看到UniswapV2Pair.sol的合约中的写法是相同的，但是它是两个10的6次方数字的比较。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_owkuwjsa5i.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>问题分析：造成这次事件的原因应该是项目方更新升级这个合约的时候，忘记了将后面的1000的2次方改为10000的二次方。</p>
<h3 id="22-audius"><strong>2.2 Audius</strong></h3>
<p>2022年7月24日，黑客从音乐流媒体协议Audius转移了1800万个AUDIO代币。攻击者发起了两次攻击，其中第一次攻击失败，第二次攻击成功。我们主要来分析第二次攻击，攻击者在创建了攻击合约后，通过攻击合约发起了攻击，包含4笔交易：</p>
<p>（1）txHash1: 0xfefd829e246002a8fd061eede7501bccb6e244a9aacea0ebceaecef5d877a984</p>
<p>（2）txHash2: 0x3c09c6306b67737227edc24c663462d870e7c2bf39e9ab66877a980c900dd5d5</p>
<p>（3）txHash3: 0x4227bca8ed4b8915c7eec0e14ad3748a88c4371d4176e716e8007249b9980dc9</p>
<p>（4）txHash4: 0x82fc23992c7433fffad0e28a1b8d11211dc4377de83e88088d79f24f4a3f28b3</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_l443oht903.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>在txHash1中，主要交易流程如下：</p>
<p>（1）通过Audius的代理合约对Governance合约进行初始化</p>
<p>（2）评估/执行84号提案，即第一次攻击提交的提案，评估为QuorumNotMet，原因是没有投票</p>
<p>（3）查询Governance代理合约的AUDIO代币余额</p>
<p>（4）提交85号提案，与84号提案相同。该提案的功能就是将Governance代理合约中的AUDIO转移到攻击合约，数量不能超过Governance代理合约的AUDIO余额</p>
<p>（5）通过代理合约对Staking合约进行初始化，将治理代币地址以及代理合约地址都设置为攻击合约</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_mq3k5y3k1c.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（6）通过代理合约对DelegateManagerV2合约进行初始化，将治理代币地址以及代理治理地址都设置为攻击合约</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_ey23w09des.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（7）通过代理合约将DelegateManagerV2合约中的服务提供者工厂合约为攻击合约</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_an1bcsmwyk.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>（8）通过代理合约将质押的代理权授权给攻击合约，授权的代币数量为1e31</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_1eqpu6qmn0.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>通过以上步骤，攻击者篡改并获取了治理系统的最高权限。</p>
<p>在txHash2中，攻击者在提交了提案85之后的3个区块内进行了投票。</p>
<p>在txHash3中，攻击者在3个区块的投票期以及1个区块的等待期之后对提案85进行了评估/执行。</p>
<p>在txHash4中，执行提案85，将18,56万枚AUDIO转移到攻击合约，攻击合约收到1800万枚AUDIO后，将其兑换为704 枚ETH。</p>
<p>最后，攻击者将兑换的ETH存入到了Tornash平台。</p>
<p>问题分析：攻击者之所以能够攻击成功，根本原因在于通过代理合约多次调用初始化函数，而初始化函数本应该只能调用一次的。以Governance合约中的初始化函数为例，其代码如下：</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_y4l03r0g3q.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>这里使用了Openzeppelin里面的初始化器initializer，initializer没有起到任何作用，原因在于代理调用。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_s3dyrt7szv.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>Openzeppelin里面的初始化器initializer中定义的两个bool类型的状态变量initialized和intializing分别占用了存储插槽slot0中的前16个字节。第1个8字节为initialized，第2个8字节为initializing。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_o2s33n76l7.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>由于代理合约本身定义了一个地址类型的状态变量proxyAdmin，其值为0x80ab62886eacfebca74511823d4699eb88fd097e，同样占用了存储插槽slot0，第1个8字节为0，第2个8字节为0x80ab6288，第3个8字节为0x6eacfebca7451182，第4个8字节为0x3d4699eb88fd097e。于是，实现合约中的initialized和intializing与代理合约中的proxyAdmin同时占用了存储插槽slot0，从而引起了存储冲突。</p>
<p>插槽0中的数据分布如下：</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_3c3vlrmiqq.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<p>初始化函数执行到initializer时，从存储插槽slot0的第1个8字节读取initialized，其值为0，即false；从存储插槽slot0的第2个8字节读取initializing，其值为0x80ab6288 &gt; 0，即true。</p>
<p><img src="https://img.bibiqing.com/news/2022/0916/7_d19tz7s9su.png" alt="一文详解十大智能合约安全威胁之合约升级漏洞"></p>
<h2 id="三预防措施"><strong>三、预防措施</strong></h2>
<p>我们了解合约升级的几种模式以及回顾了相关攻击事件后，作为开发人员应该采取哪些适当的措施来防止相关攻击？</p>
<p>（1）可升级智能合约的真正问题是从合约中迁移存储值，构建可升级智能合约的更好方法是区分不同合约中的存储和逻辑，将合约数据保存在一个仅接受来自逻辑合约调用的合约中，不断改变逻辑合约的逻辑</p>
<p>（2）在调用 delegatecall 之前检查目标合约是否存在，Solidity 不会替我们执行此检查，忽略检查可能会导致意外行为和安全问题</p>
<p>（3）仔细考虑变量声明的顺序，因为会出现变量打包存储同一个插槽、影响gas成本、内存布局、delegate调用结果等问题</p>
<p>（4）仔细考虑合约初始化问题，状态变量可能在构造时候出现未初始化，应当在初始化期间缓解潜在的竞争条件</p>
<p>（5）考虑代理模式中的函数名称，避免函数名称冲突</p>
<p>（6）项目上线前，需联系专业的第三方专业审计团队进行审计</p>
<table>
    <thead>
        <tr>
            <th style="text-align:left">推荐平台</th>
            <th style="text-align:left">链接</th>
            <th style="text-align:left">平台介绍</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">Gate芝麻开门</span></td>
            <td style="text-align:left"><span style="white-space:nowrap"><a
                        href="https://www.okbtc.cn/gateio?ref=githubio">平台介绍</a></span></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/gateio?ref=githubio">Gate.io芝麻开门创立于2013年，是全球真实交易量TOP10的加密货币交易平台，向全球数千万用户提供安全可靠、真实透明的数字资产交易服务。</a>
            </td>
        </tr>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">Bitget</span></td>
            <td style="text-align:left"><a href="https://www.okbtc.cn/bitget?ref=githubio">注册链接</a></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/bitget?ref=githubio">Bitget的背后是一群区块链技术的早期接受者，也是区块链未来发展的信仰者，一直致力于提供安全、一站式的交易解决方案，帮助用户更聪明地交易。</a>
            </td>
        </tr>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">Bybit</span></td>
            <td style="text-align:left"><a href="https://www.okbtc.cn/bybit?ref=githubio">注册链接</a></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/bybit?ref=githubio">Bybit通过数字资产与传统金融的结合，引领数字资产的生态发展。提供一流的流动性，致力于打造业内最安全、公平、高效及人性化的交易服务平台。</a>
            </td>
        </tr>
        <tr>
            <td style="text-align:left"><span style="white-space:nowrap">派网</span></td>
            <td style="text-align:left"><a href="https://www.okbtc.cn/pionex?ref=githubio">注册链接</a></td>
            <td style="text-align:left"><a
                    href="https://www.okbtc.cn/pionex?ref=githubio">派网提供多样化的量化交易机器人，用户可依照自身交易需求和策略选择最适合的机器人。 同时派网也提供合约交易与合约网格机器人，给予更方便的合约交易体验。</a>
            </td>
        </tr>
    </tbody>
</table>

        </div>

        
        



        
        


        <footer class="post-footer">
          


          
          <nav class="post-nav">
            
              <a class="prev" href="/post/42704/">
                
                <i class="iconfont">
                  <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

                </i>
                <span class="prev-text nav-default">细数 GameFi 模型发展 未来仍可期？</span>
                <span class="prev-text nav-mobile">上一篇</span>
              </a>
            
              <a class="next" href="/post/42707/">
                <span class="next-text nav-default">以太坊的下一站：“上海”升级</span>
                <span class="prev-text nav-mobile">下一篇</span>
                
                <i class="iconfont">
                  <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

                </i>
              </a>
          </nav>
        </footer>
      </article>

      
      
        
      


      
      


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">文章目录</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#一什么是合约升级"><strong>一、什么是合约升级？</strong></a>
      <ul>
        <li><a href="#11继承存储模式"><strong>1.1继承存储模式</strong></a></li>
        <li><a href="#12非结构化存储模式"><strong>1.2非结构化存储模式</strong></a></li>
        <li><a href="#13永久存储模式"><strong>1.3永久存储模式</strong></a></li>
        <li><a href="#14--diamond-模式"><strong>1.4</strong>  <strong>Diamond 模式</strong></a></li>
        <li><a href="#15-create2"><strong>1.5 create2</strong></a></li>
      </ul>
    </li>
    <li><a href="#二攻击事件分析"><strong>二、攻击事件分析</strong></a>
      <ul>
        <li><a href="#21-uranium-finance"><strong>2.1 Uranium Finance</strong></a></li>
        <li><a href="#22-audius"><strong>2.2 Audius</strong></a></li>
      </ul>
    </li>
    <li><a href="#三预防措施"><strong>三、预防措施</strong></a></li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  

<a href="https://www.okbtc.cn/binance?ref=githubio" class="iconfont">
  <img src="/image/logo/binance.png" width="36px" height="36px" alt="binance">
</a>

<a href="https://www.okbtc.cn/okx?ref=githubio" class="iconfont">
  <img src="/image/logo/okx.png" width="36px" height="36px" alt="okx">
</a>

<a href="https://www.okbtc.cn/htx?ref=githubio" class="iconfont">
  <img src="/image/logo/htx.png" width="36px" height="36px" alt="htx">
</a>

<a href="https://www.okbtc.cn/gateio?ref=githubio" class="iconfont">
  <img src="/image/logo/gateio.png" width="36px" height="36px" alt="gateio">
</a>

<a href="https://www.okbtc.cn/bitget?ref=githubio" class="iconfont">
  <img src="/image/logo/bitget.png" width="36px" height="36px" alt="bitget">
</a>

<a href="https://www.okbtc.cn/bybit?ref=githubio" class="iconfont">
  <img src="/image/logo/bybit.png" width="36px" height="36px" alt="bybit">
</a>

<a href="https://www.okbtc.cn/pionex?ref=githubio" class="iconfont">
  <img src="/image/logo/pionex.png" width="36px" height="36px" alt="pionex">
</a>



</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        coin
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.5e8c82c5ae3f71b40f78c4ff8ea351326a65ddf5771f76c10c6fc7d09808332d.js" integrity="sha256-XoyCxa4/cbQPeMT/jqNRMmpl3fV3H3bBDG/H0JgIMy0=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











<script>
  var remark_config = {
    host: 'https:\/\/remark42.example.com',
    site_id: 'remark',
    components: [
	    'embed',
    ],
  }
  !function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);
</script>







  </body>
</html>
